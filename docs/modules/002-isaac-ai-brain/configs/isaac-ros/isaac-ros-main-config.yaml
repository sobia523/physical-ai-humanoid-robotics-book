# Isaac ROS Main Configuration
# Comprehensive configuration for Isaac ROS system with all components

isaac_ros_system:
  name: "humanoid_ai_brain_pipeline"
  description: "Complete Isaac ROS pipeline for humanoid robot AI brain including perception, navigation, and control"
  version: "1.0"
  author: "Isaac ROS Developer Team"
  license: "Apache 2.0"

# Global system settings
global:
  # Enable system-wide profiling
  enable_profiling: true
  # Global log level
  log_level: "INFO"
  # Maximum processing delay allowed (seconds)
  max_processing_delay: 0.05
  # Enable detailed performance metrics
  enable_metrics: true
  # System-wide QoS settings
  qos_defaults:
    history: "keep_last"
    depth: 10
    reliability: "reliable"
    durability: "volatile"

# System architecture definition
architecture:
  # Pipeline topology
  topology: "modular_fusion"
  # Execution model
  execution_model: "hybrid"  # Options: sequential, parallel, hybrid
  # Memory management strategy
  memory_management: "pool_based"  # Options: pool_based, dynamic, unified
  # Threading model
  threading_model: "multi_threaded"  # Options: single_threaded, multi_threaded, event_driven

# Node definitions for the complete Isaac ROS pipeline
nodes:
  # 1. Perception subsystem
  - name: "perception_subsystem"
    package: "isaac_ros_perceptor"
    executable: "perception_manager_node"
    namespace: "perception"
    parameters:
      # Input topics
      camera_topic: "/front_camera/image_rect_color"
      lidar_topic: "/velodyne_points"
      imu_topic: "/imu/data"
      # Output topics
      detections_topic: "/perception/detections"
      pointcloud_topic: "/perception/pointcloud"
      features_topic: "/perception/features"
      # Perception parameters
      detection_threshold: 0.5
      max_detection_range: 50.0  # meters
      min_detection_size: 0.1   # meters
      # Hardware acceleration
      use_gpu: true
      gpu_id: 0
      tensorrt_precision: "fp16"
      # Performance settings
      input_qos_history: "keep_last"
      input_qos_depth: 10
      input_qos_reliability: "reliable"
      output_qos_history: "keep_last"
      output_qos_depth: 10
      output_qos_reliability: "reliable"
    # Hardware acceleration settings
    hardware_config:
      use_gpu: true
      gpu_id: 0
      tensorrt_precision: "fp16"
      # Optimize for perception pipeline
      enable_memory_pooling: true

  # 2. Localization subsystem
  - name: "localization_subsystem"
    package: "isaac_ros_localizer"
    executable: "localization_manager_node"
    namespace: "localization"
    parameters:
      # Input topics
      pose_topic: "/visual_slam/pose"
      map_topic: "/map_server/map"
      odom_topic: "/robot_state_publisher/odom"
      # Output topics
      localized_pose_topic: "/localization/pose"
      confidence_topic: "/localization/confidence"
      # Localization parameters
      amcl_enabled: true
      particle_count: 100
      transform_tolerance: 0.2  # seconds
      # Hardware acceleration
      use_gpu: true
      gpu_id: 0
      # Performance settings
      input_qos_history: "keep_last"
      input_qos_depth: 20
      input_qos_reliability: "reliable"
      output_qos_history: "keep_last"
      output_qos_depth: 10
      output_qos_reliability: "reliable"
    # Hardware acceleration settings
    hardware_config:
      use_gpu: true
      gpu_id: 0
      # Optimize for particle filtering
      enable_gpu_particles: true

  # 3. Mapping subsystem
  - name: "mapping_subsystem"
    package: "isaac_ros_mapper"
    executable: "mapping_manager_node"
    namespace: "mapping"
    parameters:
      # Input topics
      pose_topic: "/localization/pose"
      pointcloud_topic: "/perception/pointcloud"
      occupancy_grid_topic: "/mapping/occupancy_grid"
      # Output topics
      global_map_topic: "/map"
      local_map_topic: "/local_costmap/costmap"
      # Mapping parameters
      map_resolution: 0.05  # meters per cell
      map_size_x: 100.0  # meters
      map_size_y: 100.0  # meters
      update_frequency: 5.0  # Hz
      # Hardware acceleration
      use_gpu: true
      gpu_id: 0
      # Performance settings
      input_qos_history: "keep_last"
      input_qos_depth: 10
      input_qos_reliability: "reliable"
      output_qos_history: "keep_last"
      output_qos_depth: 5
      output_qos_reliability: "reliable"
    # Hardware acceleration settings
    hardware_config:
      use_gpu: true
      gpu_id: 0
      # Optimize for map building
      enable_gpu_ray_casting: true

  # 4. Planning subsystem
  - name: "planning_subsystem"
    package: "isaac_ros_planner"
    executable: "planning_manager_node"
    namespace: "planning"
    parameters:
      # Input topics
      global_map_topic: "/map"
      local_map_topic: "/local_costmap/costmap"
      start_pose_topic: "/planning/start_pose"
      goal_pose_topic: "/planning/goal_pose"
      # Output topics
      global_plan_topic: "/planning/global_plan"
      local_plan_topic: "/planning/local_plan"
      # Planning parameters
      planner_type: "navfn"  # Options: navfn, global_planner, teb_local_planner
      global_planner_frequency: 1.0  # Hz
      local_planner_frequency: 10.0  # Hz
      # Hardware acceleration
      use_gpu: true
      gpu_id: 0
      # Performance settings
      input_qos_history: "keep_last"
      input_qos_depth: 10
      input_qos_reliability: "reliable"
      output_qos_history: "keep_last"
      output_qos_depth: 10
      output_qos_reliability: "reliable"
    # Hardware acceleration settings
    hardware_config:
      use_gpu: true
      gpu_id: 0
      # Optimize for path planning
      enable_gpu_pathfinding: true

  # 5. Control subsystem
  - name: "control_subsystem"
    package: "isaac_ros_controller"
    executable: "control_manager_node"
    namespace: "control"
    parameters:
      # Input topics
      local_plan_topic: "/planning/local_plan"
      robot_state_topic: "/robot_state_publisher/joint_states"
      # Output topics
      velocity_commands_topic: "/cmd_vel"
      joint_commands_topic: "/joint_group_position_controller/commands"
      # Control parameters
      controller_type: "pid"  # Options: pid, mpc, dwa
      control_frequency: 50.0  # Hz
      max_linear_velocity: 1.0  # m/s
      max_angular_velocity: 1.0  # rad/s
      # Performance settings
      input_qos_history: "keep_last"
      input_qos_depth: 10
      input_qos_reliability: "reliable"
      output_qos_history: "keep_last"
      output_qos_depth: 10
      output_qos_reliability: "reliable"
    # No hardware acceleration for control (real-time requirements)

  # 6. Navigation supervisor
  - name: "navigation_supervisor"
    package: "isaac_ros_navigation"
    executable: "navigation_supervisor_node"
    namespace: "navigation"
    parameters:
      # Input topics
      localized_pose_topic: "/localization/pose"
      global_plan_topic: "/planning/global_plan"
      local_plan_topic: "/planning/local_plan"
      # Output topics
      navigation_status_topic: "/navigation/status"
      recovery_trigger_topic: "/navigation/recovery"
      # Navigation parameters
      navigation_stack_active: true
      recovery_enabled: true
      safety_monitoring: true
      # Behavior parameters
      exploration_mode: false
      patrol_mode: false
      waypoint_navigation: true
      # Performance settings
      input_qos_history: "keep_last"
      input_qos_depth: 10
      input_qos_reliability: "reliable"
      output_qos_history: "keep_last"
      output_qos_depth: 5
      output_qos_reliability: "reliable"
    # No hardware acceleration for supervision (logic-based)

# Hardware acceleration configuration
gpu_config:
  # Default GPU settings
  default_gpu_id: 0
  # Memory pool configuration
  memory_pool_size: "8192MB"
  # TensorRT cache configuration
  tensorrt_cache_size: "2048MB"
  # CUDA stream priority
  cuda_stream_priority: "normal"
  # Enable CUDA graphs for kernel fusion
  enable_cuda_graphs: true
  # Enable memory pooling for better performance
  enable_memory_pooling: true
  # Enable unified memory (set to false for compatibility)
  enable_unified_memory: false
  # GPU-specific optimizations
  optimizations:
    # For perception tasks
    perception_optimizations:
      enable_tensor_cores: true
      enable_fp16_precision: true
      enable_int8_precision: false
    # For mapping tasks
    mapping_optimizations:
      enable_ray_tracing: true
      enable_compute_shaders: true
    # For planning tasks
    planning_optimizations:
      enable_gpu_pathfinding: true
      enable_parallel_search: true

# Performance optimization settings
performance:
  # Pipeline-wide performance settings
  target_frame_rate: 30  # Hz for perception components
  max_load_threshold: 0.8  # Maximum acceptable load (0.0 to 1.0)
  # Queue size limits
  max_input_queue_size: 20
  max_output_queue_size: 10
  # Processing timeouts (seconds)
  processing_timeout: 0.1
  # Enable adaptive processing based on system load
  enable_adaptive_processing: true
  # Enable pipeline profiling
  enable_pipeline_profiling: true
  # Enable GPU memory profiling
  enable_gpu_memory_profiling: true

# Monitoring and diagnostics
monitoring:
  # Enable system health monitoring
  enable_health_monitoring: true
  # Enable performance monitoring
  enable_performance_monitoring: true
  # Enable GPU monitoring
  enable_gpu_monitoring: true
  # Health check parameters
  health_check_interval: 1.0  # seconds
  performance_monitoring_interval: 0.5  # seconds
  gpu_monitoring_interval: 1.0  # seconds
  # Diagnostic topics
  diagnostic_topic: "/diagnostics"
  performance_topic: "/performance_metrics"
  gpu_metrics_topic: "/gpu_metrics"
  # Logging settings
  enable_detailed_logging: false
  log_level: "INFO"
  metrics_output_file: "/tmp/isaac_ros_system_metrics.json"

# Sensor configuration
sensors:
  # Camera configuration
  camera:
    front_camera:
      topic: "/front_camera/image_rect_color"
      info_topic: "/front_camera/camera_info"
      width: 1280
      height: 720
      fps: 30
      distortion_model: "rational_polynomial"
    left_camera:
      topic: "/left_camera/image_rect_color"
      info_topic: "/left_camera/camera_info"
      width: 1280
      height: 720
      fps: 30
      distortion_model: "rational_polynomial"
    right_camera:
      topic: "/right_camera/image_rect_color"
      info_topic: "/right_camera/camera_info"
      width: 1280
      height: 720
      fps: 30
      distortion_model: "rational_polynomial"

  # LiDAR configuration
  lidar:
    main_lidar:
      topic: "/velodyne_points"
      frame_id: "velodyne"
      max_range: 100.0
      min_range: 0.5
      scan_frequency: 10.0
      channels: 64

  # IMU configuration
  imu:
    main_imu:
      topic: "/imu/data"
      frame_id: "imu_link"
      update_rate: 100.0
      linear_acceleration_covariance: [0.01, 0, 0, 0, 0.01, 0, 0, 0, 0.01]
      angular_velocity_covariance: [0.01, 0, 0, 0, 0.01, 0, 0, 0, 0.01]

  # Odometry configuration
  odometry:
    wheel_odom:
      topic: "/odom"
      frame_id: "odom"
      child_frame_id: "base_footprint"
      update_rate: 50.0

# Calibration and transformation settings
calibration:
  # Camera calibration files
  camera_calibrations:
    front_camera: "/calibration/front_camera.yaml"
    left_camera: "/calibration/left_camera.yaml"
    right_camera: "/calibration/right_camera.yaml"
  # LiDAR calibration
  lidar_calibration: "/calibration/lidar_calibration.yaml"
  # IMU calibration
  imu_calibration: "/calibration/imu_calibration.yaml"
  # Transformation tree
  tf_tree: "/calibration/tf_tree.yaml"
  # Extrinsics calibration
  extrinsics:
    camera_to_base: "/calibration/camera_to_base.yaml"
    lidar_to_base: "/calibration/lidar_to_base.yaml"
    imu_to_base: "/calibration/imu_to_base.yaml"

# Synchronization settings
synchronization:
  # Camera-LiDAR synchronization
  camera_lidar_sync:
    max_time_diff: 0.05  # seconds
    sync_method: "approximate_time"
    queue_size: 10
  # Multi-sensor synchronization
  multi_sensor_sync:
    max_time_diff: 0.02  # seconds
    sync_method: "approximate_time"
    queue_size: 20
  # IMU-camera synchronization
  imu_camera_sync:
    max_time_diff: 0.01  # seconds
    sync_method: "approximate_time"
    queue_size: 10

# Safety and fail-safe mechanisms
safety:
  # Enable safety monitoring
  enable_safety_monitoring: true
  # Collision avoidance
  collision_avoidance:
    enabled: true
    detection_distance: 1.0  # meters
    safe_distance: 0.5  # meters
    emergency_stop_threshold: 0.3  # meters
  # Sensor failure detection
  sensor_failure_detection:
    enabled: true
    detection_timeout: 1.0  # seconds
    backup_behavior: "stop_and_wait"
  # System health checks
  system_health_checks:
    enabled: true
    cpu_threshold: 0.9  # 90%
    memory_threshold: 0.9  # 90%
    gpu_threshold: 0.9  # 90%
    action_on_failure: "shutdown_gracefully"

# Recovery and fault tolerance
recovery:
  # Enable recovery behaviors
  enable_recovery_behaviors: true
  # Recovery strategies
  strategies:
    sensor_failure:
      retry_attempts: 3
      retry_delay: 1.0  # seconds
      fallback_sensor: "backup_camera"
    localization_failure:
      reinitialization_attempts: 5
      reinitialization_delay: 2.0  # seconds
      manual_recoverable: true
    navigation_failure:
      clearing_rotation: true
      back_up: true
      spiral_out: false
  # Emergency procedures
  emergency_procedures:
    full_emergency_stop: true
    safe_pose_return: true
    communication_loss_protocol: "return_to_home"

# Hardware-specific configurations
hardware_profiles:
  # For Jetson AGX Orin (balanced performance)
  jetson_agx_orin:
    gpu_config:
      default_gpu_id: 0
      memory_pool_size: "6144MB"
      tensorrt_cache_size: "1024MB"
    performance:
      target_frame_rate: 15
      max_load_threshold: 0.7
    nodes:
      perception:
        max_detection_range: 25.0
        detection_threshold: 0.6
      localization:
        particle_count: 50
      mapping:
        map_resolution: 0.1

  # For desktop RTX 3080 (high performance)
  desktop_rtx_3080:
    gpu_config:
      default_gpu_id: 0
      memory_pool_size: "16384MB"
      tensorrt_cache_size: "4096MB"
    performance:
      target_frame_rate: 30
      max_load_threshold: 0.9
    nodes:
      perception:
        max_detection_range: 50.0
        detection_threshold: 0.5
      localization:
        particle_count: 200
      mapping:
        map_resolution: 0.05

  # For RTX 4090 (maximum performance)
  desktop_rtx_4090:
    gpu_config:
      default_gpu_id: 0
      memory_pool_size: "24576MB"
      tensorrt_cache_size: "8192MB"
    performance:
      target_frame_rate: 60
      max_load_threshold: 0.95
    nodes:
      perception:
        max_detection_range: 100.0
        detection_threshold: 0.3
      localization:
        particle_count: 500
      mapping:
        map_resolution: 0.025

# Launch configuration
launch_config:
  # Use composable node container for better performance
  use_composable_nodes: true
  # Container name
  container_name: "isaac_ros_main_container"
  # Executor type
  executor_type: "multi_threaded"
  # Number of executor threads
  executor_threads: 8
  # Container output destination
  container_output: "screen"
  # Node startup ordering
  startup_order:
    - "perception_subsystem"
    - "localization_subsystem"
    - "mapping_subsystem"
    - "planning_subsystem"
    - "control_subsystem"
    - "navigation_supervisor"

# Quality of Service settings
qos_profiles:
  # High-frequency sensor data (e.g., camera, LiDAR)
  sensor_data:
    history: "keep_last"
    depth: 5
    reliability: "reliable"
    durability: "volatile"
    deadline: "100ms"
    lifespan: "1s"

  # Low-frequency data (e.g., maps, goals)
  low_frequency:
    history: "keep_last"
    depth: 10
    reliability: "reliable"
    durability: "transient_local"
    deadline: "1s"
    lifespan: "10s"

  # Control commands
  control_commands:
    history: "keep_last"
    depth: 1
    reliability: "reliable"
    durability: "volatile"
    deadline: "10ms"
    lifespan: "100ms"

  # Diagnostic information
  diagnostics:
    history: "keep_all"
    depth: 100
    reliability: "best_effort"
    durability: "volatile"
    deadline: "1s"
    lifespan: "10s"

# Resource management
resource_management:
  # Memory limits per node (MB)
  memory_limits:
    perception_subsystem: 2048
    localization_subsystem: 1024
    mapping_subsystem: 4096
    planning_subsystem: 2048
    control_subsystem: 512
    navigation_supervisor: 512

  # CPU affinity settings (for real-time performance)
  cpu_affinity:
    enable_cpu_affinity: true
    perception_cpus: [0, 1]
    localization_cpus: [2, 3]
    mapping_cpus: [4, 5]
    planning_cpus: [6, 7]
    control_cpus: [8]  # Dedicated core for control
    navigation_supervisor_cpus: [9]

  # GPU memory management
  gpu_memory_management:
    enable_memory_pooling: true
    memory_pool_size: "8192MB"
    preallocate_memory: true
    memory_fragmentation_threshold: 0.8

# Communication settings
communication:
  # Inter-process communication settings
  ipc_settings:
    enable_intraprocess_comms: true
    enable_datasharing: true
    shared_memory_size: "1024MB"

  # Network communication (for distributed systems)
  network_settings:
    enable_network_comms: false
    network_protocol: "udp"
    network_port_base: 10000
    network_qos:
      reliability: "reliable"
      durability: "volatile"
      max_message_size: "10MB"

# Example usage commands:
#
# 1. Launch the complete Isaac ROS pipeline:
#    ros2 launch isaac_ros_main_pipeline.launch.py
#
# 2. Launch with specific hardware profile:
#    ros2 launch isaac_ros_main_pipeline.launch.py hardware_profile:=desktop_rtx_3080
#
# 3. Monitor system performance:
#    ros2 run isaac_ros_common system_monitor
#
# 4. Visualize Isaac ROS outputs:
#    ros2 run rviz2 rviz2 -d isaac_ros_visualization.rviz
#
# 5. Run system diagnostics:
#    ros2 run diagnostic_aggregator aggregator_node