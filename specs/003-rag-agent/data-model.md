# Data Model: RAG Chatbot — Agent + Retrieval Implementation

## Overview
This document defines the key data structures and entities for the RAG Chatbot Agent implementation.

## Core Entities

### Query
**Description**: Represents a user's input to the system
**Fields**:
- query_text: string - The user's question or text input
- selected_text: string? - Optional text selected by the user for context
- metadata: object - Additional context information (timestamp, user info, etc.)

### RetrievedChunk
**Description**: A piece of content retrieved from Qdrant that matches the query
**Fields**:
- id: string - Unique identifier for the chunk in Qdrant
- content: string - The actual text content of the chunk
- url: string - Source URL where the content originated
- module: string - Module name in the book structure
- chapter: string - Chapter name in the book structure
- heading: string - Section heading for the content
- score: float - Similarity score between query and chunk
- metadata: object - Additional metadata stored with the chunk

### AgentResponse
**Description**: The final response generated by the agent
**Fields**:
- answer: string - The agent's response to the user's query
- sources: array[RetrievedChunk] - List of sources used to generate the response
- confidence: float - Overall confidence in the response (based on retrieval scores)
- timestamp: string - When the response was generated
- query_id: string - Reference to the original query

### AgentContext
**Description**: Context maintained during an agent conversation session
**Fields**:
- session_id: string - Unique identifier for the conversation session
- history: array[object] - Conversation history (user queries and agent responses)
- current_query: Query - The current query being processed
- retrieved_context: array[RetrievedChunk] - Context retrieved for the current query
- tools: array[object] - Available tools for the agent to use

## State Transitions

### Query Processing Flow
1. **Query Received**: User input is received and validated
2. **Embedding Generated**: Text embedding is created from the query
3. **Retrieval Executed**: Qdrant is queried for relevant chunks
4. **Context Injected**: Retrieved chunks are formatted and injected into the agent prompt
5. **Response Generated**: Agent generates a response based on the retrieved context
6. **Response Formatted**: Response is structured with sources and returned to user

## Validation Rules

### Query Validation
- query_text must be non-empty
- query_text length must be less than 1000 characters
- selected_text (if provided) must be non-empty

### RetrievedChunk Validation
- content must be non-empty
- url must be a valid URL format
- score must be between 0 and 1
- id must match Qdrant record ID format

### AgentResponse Validation
- answer must be non-empty
- sources array must contain at least one source when confidence > 0.5
- confidence must be between 0 and 1
- timestamp must be in ISO 8601 format

## Relationships

- **Query** → **RetrievedChunk**: One query can result in multiple retrieved chunks (1:*)
- **RetrievedChunk** → **AgentResponse**: Multiple chunks contribute to one response (*:1)
- **Query** → **AgentResponse**: One query generates one response (1:1)
- **AgentContext** → **Query**: One context can contain multiple queries over time (1:*)